{% extends "base.html" %}

{% block title %}Dashboard - DataHub{% endblock %}

{% block content %}
<h1 class="text-3xl font-bold mb-8">Dashboard</h1>

<!-- Primary Stats Cards -->
<div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
    <div class="bg-gray-800 rounded-lg p-6 border border-gray-700">
        <div class="text-gray-400 text-sm uppercase tracking-wide">Daily Steps</div>
        <div class="text-3xl font-bold text-green-400 mt-2">{{ "{:,.0f}".format(steps_week / 7) }}</div>
        <div class="text-gray-500 text-sm mt-1">{{ "{:,}".format(steps_week) }} this week</div>
    </div>

    <div class="bg-gray-800 rounded-lg p-6 border border-gray-700">
        <div class="text-gray-400 text-sm uppercase tracking-wide">Workouts This Week</div>
        <div class="text-3xl font-bold text-blue-400 mt-2">{{ workouts_week }}</div>
    </div>

    <div class="bg-gray-800 rounded-lg p-6 border border-gray-700">
        <div class="text-gray-400 text-sm uppercase tracking-wide">Daily Spending</div>
        <div class="text-3xl font-bold text-red-400 mt-2">${{ "{:,.2f}".format(spending_month / 30) }}</div>
        {% if spending_change is not none %}
        <div class="text-sm mt-1 {% if spending_change > 0 %}text-red-400{% else %}text-green-400{% endif %}">
            {% if spending_change > 0 %}+{% endif %}{{ "{:.1f}".format(spending_change) }}% vs last month
        </div>
        {% else %}
        <div class="text-gray-500 text-sm mt-1">${{ "{:,.2f}".format(spending_month) }} this month</div>
        {% endif %}
    </div>
</div>

<!-- Secondary Stats Cards (Calories, Sleep, HRV) -->
<div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
    <div class="bg-gray-800 rounded-lg p-6 border border-gray-700">
        <div class="text-gray-400 text-sm uppercase tracking-wide">Daily Active Cal</div>
        <div class="text-2xl font-bold text-orange-400 mt-2">{{ "{:,.0f}".format(active_calories_week / 7) }}</div>
        <div class="text-gray-500 text-sm mt-1">{{ "{:,}".format(active_calories_week) }} this week</div>
    </div>

    <div class="bg-gray-800 rounded-lg p-6 border border-gray-700">
        <div class="text-gray-400 text-sm uppercase tracking-wide">Daily Total Cal</div>
        <div class="text-2xl font-bold text-yellow-400 mt-2">{{ "{:,.0f}".format(total_calories_week / 7) }}</div>
        <div class="text-gray-500 text-sm mt-1">{{ "{:,}".format(total_calories_week) }} this week</div>
    </div>

    <div class="bg-gray-800 rounded-lg p-6 border border-gray-700">
        <div class="text-gray-400 text-sm uppercase tracking-wide">Avg Sleep</div>
        <div class="text-2xl font-bold text-purple-400 mt-2">{{ "{:.1f}".format(avg_sleep_hours) }} hrs</div>
        <div class="text-gray-500 text-sm mt-1">last 7 days</div>
    </div>

    <div class="bg-gray-800 rounded-lg p-6 border border-gray-700">
        <div class="text-gray-400 text-sm uppercase tracking-wide">Avg HRV</div>
        <div class="text-2xl font-bold text-cyan-400 mt-2">{{ "{:.0f}".format(avg_hrv) }} ms</div>
        <div class="text-gray-500 text-sm mt-1">last 7 days</div>
    </div>
</div>

<!-- Charts Row 1: Steps and Calories -->
<div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
    <!-- Steps Chart -->
    <div class="bg-gray-800 rounded-lg p-6 border border-gray-700">
        <h2 class="text-xl font-semibold mb-4">Daily Steps (Last 14 Days)</h2>
        <canvas id="stepsChart" height="200"></canvas>
    </div>

    <!-- Calories Chart -->
    <div class="bg-gray-800 rounded-lg p-6 border border-gray-700">
        <h2 class="text-xl font-semibold mb-4">Daily Calories (Last 14 Days)</h2>
        <canvas id="caloriesChart" height="200"></canvas>
    </div>
</div>

<!-- Charts Row 2: Sleep and Data Summary -->
<div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
    <!-- Sleep Chart -->
    <div class="bg-gray-800 rounded-lg p-6 border border-gray-700">
        <h2 class="text-xl font-semibold mb-4">Sleep Duration (Last 14 Days)</h2>
        <canvas id="sleepChart" height="200"></canvas>
    </div>

    <!-- Data by Type -->
    <div class="bg-gray-800 rounded-lg p-6 border border-gray-700">
        <h2 class="text-xl font-semibold mb-4">Data by Type</h2>
        <div class="space-y-3 max-h-64 overflow-y-auto">
            {% for row in data_by_type %}
            <div class="flex justify-between items-center">
                <span class="text-gray-300">{{ row.data_type }}</span>
                <span class="text-gray-400">{{ "{:,}".format(row.count) }} records</span>
            </div>
            {% endfor %}
        </div>
    </div>
</div>

<!-- Recent Transactions -->
<div class="bg-gray-800 rounded-lg p-6 border border-gray-700">
    <h2 class="text-xl font-semibold mb-4">Recent Transactions</h2>
    {% if recent_txns %}
    <table class="w-full">
        <thead>
            <tr class="text-left text-gray-400 text-sm border-b border-gray-700">
                <th class="pb-2">Date</th>
                <th class="pb-2">Description</th>
                <th class="pb-2">Category</th>
                <th class="pb-2 text-right">Amount</th>
            </tr>
        </thead>
        <tbody>
            {% for txn in recent_txns %}
            <tr class="border-b border-gray-700/50">
                <td class="py-2 text-gray-400">{{ txn.date.strftime('%m/%d') }}</td>
                <td class="py-2">{{ txn.description[:35] }}{% if txn.description|length > 35 %}...{% endif %}</td>
                <td class="py-2 text-gray-400">{{ txn.category or '-' }}</td>
                <td class="py-2 text-right {% if txn.amount < 0 %}text-red-400{% else %}text-green-400{% endif %}">
                    ${{ "{:,.2f}".format(txn.amount) }}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <p class="text-gray-400">No transactions yet. Import some bank data to get started.</p>
    {% endif %}
</div>

<script>
    // Common chart options
    const commonOptions = {
        responsive: true,
        plugins: {
            legend: { display: false }
        },
        scales: {
            y: {
                beginAtZero: true,
                grid: { color: 'rgba(255,255,255,0.1)' },
                ticks: { color: '#9ca3af' }
            },
            x: {
                grid: { display: false },
                ticks: { color: '#9ca3af' }
            }
        }
    };

    // Steps chart
    const stepsData = {{ daily_steps | tojson }};
    new Chart(document.getElementById('stepsChart'), {
        type: 'bar',
        data: {
            labels: stepsData.map(d => d.date),
            datasets: [{
                label: 'Steps',
                data: stepsData.map(d => d.total),
                backgroundColor: 'rgba(34, 197, 94, 0.5)',
                borderColor: 'rgb(34, 197, 94)',
                borderWidth: 1
            }]
        },
        options: {
            ...commonOptions,
            plugins: {
                ...commonOptions.plugins,
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return context.dataset.label + ': ' + Math.round(context.raw).toLocaleString();
                        }
                    }
                }
            }
        }
    });

    // Calories chart (stacked bar: active + resting)
    const caloriesData = {{ daily_calories | tojson }};
    new Chart(document.getElementById('caloriesChart'), {
        type: 'bar',
        data: {
            labels: caloriesData.map(d => d.date),
            datasets: [
                {
                    label: 'Active',
                    data: caloriesData.map(d => d.active),
                    backgroundColor: 'rgba(251, 146, 60, 0.7)',
                    borderColor: 'rgb(251, 146, 60)',
                    borderWidth: 1
                },
                {
                    label: 'Resting',
                    data: caloriesData.map(d => d.resting),
                    backgroundColor: 'rgba(250, 204, 21, 0.5)',
                    borderColor: 'rgb(250, 204, 21)',
                    borderWidth: 1
                }
            ]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    display: true,
                    labels: { color: '#9ca3af' }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return context.dataset.label + ': ' + Math.round(context.raw).toLocaleString();
                        }
                    }
                }
            },
            scales: {
                y: {
                    stacked: true,
                    beginAtZero: true,
                    grid: { color: 'rgba(255,255,255,0.1)' },
                    ticks: { color: '#9ca3af' }
                },
                x: {
                    stacked: true,
                    grid: { display: false },
                    ticks: { color: '#9ca3af' }
                }
            }
        }
    });

    // Sleep chart (line chart)
    const sleepData = {{ daily_sleep | tojson }};
    new Chart(document.getElementById('sleepChart'), {
        type: 'line',
        data: {
            labels: sleepData.map(d => d.date),
            datasets: [{
                label: 'Sleep',
                data: sleepData.map(d => d.hours),
                backgroundColor: 'rgba(168, 85, 247, 0.2)',
                borderColor: 'rgb(168, 85, 247)',
                borderWidth: 2,
                fill: true,
                tension: 0.3
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: { display: false },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return 'Sleep: ' + context.raw.toFixed(1) + ' hrs';
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: false,
                    min: 4,
                    max: 10,
                    grid: { color: 'rgba(255,255,255,0.1)' },
                    ticks: {
                        color: '#9ca3af',
                        callback: function(value) { return value + 'h'; }
                    }
                },
                x: {
                    grid: { display: false },
                    ticks: { color: '#9ca3af' }
                }
            }
        }
    });
</script>
{% endblock %}
